{% extends "base.html" %}

{% block content %}
<div class="auth-container" style="max-width: 500px; margin: 50px auto; padding: 30px; background: white; border-radius: var(--border-radius); box-shadow: var(--box-shadow); border: 1px solid #e0e0e0;">
    <h2 style="text-align: center; margin-bottom: 25px; color: var(--primary-color);">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <form method="post" id="register-form">
        {% csrf_token %}
        {% for field in form %}
        <div class="form-group" style="margin-bottom: 20px; position: relative;">
            <label for="{{ field.id_for_label }}" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--primary-color);">{{ field.label }}</label>
            {{ field }}
            {% if 'password' in field.name %}
            <button type="button" class="toggle-password" onclick="togglePassword('{{ field.id_for_label }}')"
                    style="position: absolute; right: 10px; top: 35px; background: none; border: none; cursor: pointer;">
                üëÅÔ∏è
            </button>
            {% endif %}
            <div class="error-message" id="error-{{ field.name }}" style="color: #dc3545; font-size: 0.9rem; margin-top: 5px;"></div>
            {% if field.errors %}
            <div class="error-message" style="color: #dc3545; font-size: 0.9rem; margin-top: 5px;">
                {{ field.errors }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
        <button type="submit" class="btn" id="submit-btn" style="width: 100%; padding: 12px; font-size: 1rem;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    </form>
    <p style="text-align: center; margin-top: 20px; color: var(--light-text);">
        –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="{% url 'login' %}" style="color: var(--primary-color); text-decoration: none;">–í–æ–π–¥–∏—Ç–µ</a>
    </p>
</div>

<style>
    .form-group input {
        width: 100%;
        padding: 12px;
        padding-right: 40px;
        border: 1px solid #e0e0e0;
        border-radius: var(--border-radius);
        font-size: 1rem;
        box-sizing: border-box;
    }

    .toggle-password {
        z-index: 2;
    }

    input.invalid {
        border-color: #dc3545;
    }

    input.valid {
        border-color: #28a745;
    }

    .password-requirements {
        margin-top: 5px;
        font-size: 0.8rem;
        color: #6c757d;
    }

    .requirement {
        display: flex;
        align-items: center;
        margin-bottom: 3px;
    }

    .requirement.unmet {
        color: #dc3545;
    }

    .requirement.met {
        color: #28a745;
    }

    .requirement-icon {
        margin-right: 5px;
        font-size: 0.9rem;
    }
</style>

<script>
    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
        input.setAttribute('type', type);
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –ª–µ—Ç—É
    document.addEventListener('DOMContentLoaded', function() {
        const usernameInput = document.getElementById('id_username');
        const emailInput = document.getElementById('id_email');
        const password1Input = document.getElementById('id_password1');
        const password2Input = document.getElementById('id_password2');
        const form = document.getElementById('register-form');
        const submitBtn = document.getElementById('submit-btn');

        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø–∞—Ä–æ–ª—é
        const passwordRequirements = document.createElement('div');
        passwordRequirements.className = 'password-requirements';
        passwordRequirements.innerHTML = `
            <div class="requirement" id="length-req">
                <span class="requirement-icon">‚ùå</span>
                <span>–ù–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤</span>
            </div>
            <div class="requirement" id="number-req">
                <span class="requirement-icon">‚ùå</span>
                <span>–°–æ–¥–µ—Ä–∂–∏—Ç —Ü–∏—Ñ—Ä—ã</span>
            </div>
            <div class="requirement" id="letter-req">
                <span class="requirement-icon">‚ùå</span>
                <span>–°–æ–¥–µ—Ä–∂–∏—Ç –±—É–∫–≤—ã</span>
            </div>
        `;
        password1Input.parentNode.insertBefore(passwordRequirements, password1Input.nextSibling);

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ª–æ–≥–∏–Ω–∞
        if (usernameInput) {
            usernameInput.addEventListener('input', function() {
                const username = usernameInput.value;
                const errorElement = document.getElementById('error-username');

                if (username.length < 3) {
                    errorElement.textContent = '–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
                    usernameInput.classList.add('invalid');
                    usernameInput.classList.remove('valid');
                    return;
                } else {
                    errorElement.textContent = '';
                    usernameInput.classList.remove('invalid');
                    usernameInput.classList.add('valid');
                }

                // AJAX –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –ª–æ–≥–∏–Ω–∞
                if (username.length >= 3) {
                    fetch('/check_username/?username=' + encodeURIComponent(username))
                        .then(response => response.json())
                        .then(data => {
                            if (data.exists) {
                                errorElement.textContent = '–≠—Ç–æ—Ç –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç';
                                usernameInput.classList.add('invalid');
                                usernameInput.classList.remove('valid');
                            } else {
                                errorElement.textContent = '';
                                usernameInput.classList.remove('invalid');
                                usernameInput.classList.add('valid');
                            }
                        });
                }
            });
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è email
        emailInput.addEventListener('input', function() {
            const email = emailInput.value;
            const errorElement = document.getElementById('error-email');

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ email
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                errorElement.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å';
                emailInput.classList.add('invalid');
                emailInput.classList.remove('valid');
                return;
            } else {
                errorElement.textContent = '';
                emailInput.classList.remove('invalid');
                emailInput.classList.add('valid');
            }

            // AJAX –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ email
            if (email.length > 5) {
                fetch('/check_email/?email=' + encodeURIComponent(email))
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            errorElement.textContent = '–≠—Ç–æ—Ç email —É–∂–µ –∑–∞–Ω—è—Ç';
                            emailInput.classList.add('invalid');
                            emailInput.classList.remove('valid');
                        } else {
                            errorElement.textContent = '';
                            emailInput.classList.remove('invalid');
                            emailInput.classList.add('valid');
                        }
                    });
            }
        });

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
        password1Input.addEventListener('input', function() {
            const password = password1Input.value;
            const errorElement = document.getElementById('error-password1');

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –ø–∞—Ä–æ–ª—è
            const lengthReq = document.getElementById('length-req');
            if (password.length >= 8) {
                lengthReq.classList.add('met');
                lengthReq.classList.remove('unmet');
                lengthReq.querySelector('.requirement-icon').textContent = '‚úì';
            } else {
                lengthReq.classList.add('unmet');
                lengthReq.classList.remove('met');
                lengthReq.querySelector('.requirement-icon').textContent = '‚ùå';
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ü–∏—Ñ—Ä
            const numberReq = document.getElementById('number-req');
            if (/\d/.test(password)) {
                numberReq.classList.add('met');
                numberReq.classList.remove('unmet');
                numberReq.querySelector('.requirement-icon').textContent = '‚úì';
            } else {
                numberReq.classList.add('unmet');
                numberReq.classList.remove('met');
                numberReq.querySelector('.requirement-icon').textContent = '‚ùå';
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±—É–∫–≤
            const letterReq = document.getElementById('letter-req');
            if (/[a-zA-Z–∞-—è–ê-–Ø]/.test(password)) {
                letterReq.classList.add('met');
                letterReq.classList.remove('unmet');
                letterReq.querySelector('.requirement-icon').textContent = '‚úì';
            } else {
                letterReq.classList.add('unmet');
                letterReq.classList.remove('met');
                letterReq.querySelector('.requirement-icon').textContent = '‚ùå';
            }

            // –û–±—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
            if (password.length >= 8 && /\d/.test(password) && /[a-zA-Z–∞-—è–ê-–Ø]/.test(password)) {
                password1Input.classList.remove('invalid');
                password1Input.classList.add('valid');
                errorElement.textContent = '';
            } else {
                password1Input.classList.add('invalid');
                password1Input.classList.remove('valid');
                errorElement.textContent = '–ü–∞—Ä–æ–ª—å –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º';
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π, –µ—Å–ª–∏ –≤—Ç–æ—Ä–æ–π –ø–∞—Ä–æ–ª—å —É–∂–µ –≤–≤–µ–¥–µ–Ω
            if (password2Input.value) {
                validatePasswordMatch();
            }
        });

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
        password2Input.addEventListener('input', validatePasswordMatch);

        function validatePasswordMatch() {
            const errorElement = document.getElementById('error-password2');

            if (password2Input.value !== password1Input.value) {
                errorElement.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
                password2Input.classList.add('invalid');
                password2Input.classList.remove('valid');
            } else {
                errorElement.textContent = '';
                password2Input.classList.remove('invalid');
                if (password2Input.value) {
                    password2Input.classList.add('valid');
                }
            }
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
        form.addEventListener('submit', function(event) {
            let isValid = true;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–Ω–∞
            if (usernameInput && usernameInput.value.length < 3) {
                document.getElementById('error-username').textContent = '–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
                isValid = false;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ email
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value)) {
                document.getElementById('error-email').textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å';
                isValid = false;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
            if (password1Input.value.length < 8 || !/\d/.test(password1Input.value) || !/[a-zA-Z–∞-—è–ê-–Ø]/.test(password1Input.value)) {
                document.getElementById('error-password1').textContent = '–ü–∞—Ä–æ–ª—å –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º';
                isValid = false;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
            if (password2Input.value !== password1Input.value) {
                document.getElementById('error-password2').textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
                isValid = false;
            }

            if (!isValid) {
                event.preventDefault();
            }
        });
    });
</script>
{% endblock %}